<!DOCTYPE html>
<html>
<head>
  <title><%= blog.title %></title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<%- include('partials/header') %>

<div class="container mt-5">
  <h1 class="mb-3"><%= blog.title %></h1>

  <small class="text-white d-block mb-2">
    By <%= blog.author ? blog.author.username : "Unknown" %>
    on <%= blog.createdAt ? blog.createdAt.toDateString() : "Unknown date" %>
  </small>

  <% if (blog.categories && blog.categories.length) { %>
    <p class="text-info mt-2">Categories: <%= blog.categories.join(", ") %></p>
  <% } %>

  <% if (blog.image) { %>
    <img src="<%= blog.image %>" class="img-fluid rounded my-3" alt="Blog cover">
  <% } %>

  <p class="fs-5"><%= blog.content %></p>

  <!-- Like / Share -->
  <div class="mt-4">
    <% const likesCount = (blog.likes && blog.likes.length) ? blog.likes.length : 0; %>
    <% if (userId) { %>
      <form action="/<%= blog._id %>/like" method="POST" class="d-inline">
        <button type="submit" class="btn btn-outline-primary">
          ‚ù§Ô∏è Like (<%= likesCount %>)
        </button>
      </form>
    <% } else { %>
      <p><a href="/login">Login</a> to like this blog</p>
    <% } %>

    <button 
      class="btn btn-outline-info"
      onclick="navigator.clipboard.writeText('<%= shareUrl %>').then(()=>alert('Link copied!'));">
      üîó Share
    </button>
  </div>

  <!-- Edit/Delete if owner -->
  <div class="mt-3">
    <a href="/" class="btn btn-outline-light">‚Üê Back to Blogs</a>
    <% if (userId && blog.author && blog.author._id.toString() === userId.toString()) { %>
      <a href="/<%= blog._id %>/edit" class="btn btn-warning">Edit</a>
      <form action="/<%= blog._id %>?_method=DELETE" method="POST" class="d-inline">
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    <% } %>
  </div>

  <!-- Comments Section -->
  <div class="mt-5">
    <% const commentsCount = (blog.comments && blog.comments.length) ? blog.comments.length : 0; %>
    <h3>Comments (<%= commentsCount %>)</h3>

    <% if (userId) { %>
      <form action="/<%= blog._id %>/comment" method="POST" class="mb-3">
        <textarea name="text" class="form-control mb-2" rows="3" placeholder="Write a comment..." required></textarea>
        <button type="submit" class="btn btn-success">Post Comment</button>
      </form>
    <% } else { %>
      <p><a href="/login">Login</a> to comment</p>
    <% } %>

    <% if (commentsCount > 0) { %>
      <ul class="list-group">
        <% blog.comments.forEach(comment => { %>
          <li class="list-group-item bg-dark text-white">
            <strong><%= comment.user ? comment.user.username : "Anonymous" %></strong>
            <small class="text-muted"> (<%= comment.createdAt ? new Date(comment.createdAt).toDateString() : "" %>)</small>
            <p><%= comment.text %></p>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No comments yet.</p>
    <% } %>
  </div>
</div>

<%- include('partials/footer') %>
</body>
</html>
